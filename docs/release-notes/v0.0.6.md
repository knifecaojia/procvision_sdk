# ProcVision Algorithm SDK v0.0.6 Release Notes

## 概览
- 新增协议适配器模块 `procvision_algorithm_sdk.adapter`，满足《协议适配器设计与开发规范》要求。
- 简化启动命令，支持自动发现算法入口 `manifest.entry_point`，可省略 `--entry`。
- 对齐帧协议与心跳、调用路由、关闭与错误处理，提升稳定性与可诊断性。
- 版本升级：`pyproject.toml` 由 `0.0.5` 更新为 `0.0.6`。
- CLI 变更：`procvision-cli run` 改为通过适配器子进程运行，按帧协议与共享内存进行通信；保留 `--legacy-run` 兼容旧路径。
 - CLI 变更：`procvision-cli validate` 支持 `--full` 使用适配器子进程执行完整握手与 `pre/execute` 校验；保留 `--legacy-validate` 旧的本地导入校验。

## 新增功能
- 适配器以 `python -m procvision_algorithm_sdk.adapter` 启动，启动后立即输出 `hello` 帧并进入事件循环。
- 自动发现入口优先级：
  1. CLI `--entry <module:Class>`
  2. 环境变量 `PROC_ENTRY_POINT`
  3. `manifest.json` 的 `entry_point`
  4. `manifest.yaml` 行解析 `entry_point: <module:Class>`
  5. `pyproject.toml` `[tool.procvision.algorithm] entry_point = "<module:Class>"`
  6. 默认 `algorithm.main:Algorithm`（若存在）
- 帧协议：
  - 写入：`[4字节大端长度][UTF-8 JSON]`
  - `hello/ping/pong/call/result/shutdown/error` 类型支持
  - 关联规则：`result.request_id == call.request_id`
- 路由与状态机：
  - 串行单并发，收到并发 `call` 时返回 `error`（busy）
  - `phase=pre` 调用 `pre_execute`，`phase=execute` 调用 `execute`
  - 调用前后触发 `on_step_start/on_step_finish`
- 日志与诊断：
  - 使用 `StructuredLogger` 输出 JSON Lines 到 `stderr`

## 变更明细
- 新增目录 `procvision_algorithm_sdk/adapter`，包含 `__main__.py` 入口。
- `pyproject.toml`：项目版本更新为 `0.0.6`。
- 规范文档 `protocol_adapter_spec.md`：
  - 增补简化启动命令与入口自动发现规则
  - 明确错误码与结果字段语义

## 兼容性
- 向后兼容：保留原有 CLI 模块与 API；适配器为新增模块，不影响既有调用。
- 若 Runner 继续显式传递 `--entry`，优先使用显式入口。

## 升级指南
- 升级到 `v0.0.6` 后，Runner 可直接使用简化命令：
  - Windows：`<deployed_dir>\venv\Scripts\python.exe -m procvision_algorithm_sdk.adapter`
  - Linux：`<deployed_dir>/venv/bin/python -m procvision_algorithm_sdk.adapter`
- 确保工作目录为算法包根或设置 `PROC_ALGO_ROOT`；入口可通过 `manifest.json` 或 `pyproject.toml` 指定。
 - 本地开发：使用 `procvision-cli run <project> --pid <pid> --image <img>` 以适配器子进程模式运行；如需旧路径，添加 `--legacy-run`。

## 验收建议
- 运行端到端集成测试，覆盖 `hello/ping/pong/call/result/shutdown/error`。
- 验证共享内存读写与颜色空间处理，检查日志与协议隔离。
