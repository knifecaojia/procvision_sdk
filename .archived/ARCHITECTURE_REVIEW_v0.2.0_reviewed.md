# ProcVisionç®—æ³•SDKæ¶æ„å®¡æŸ¥æŠ¥å‘Š - å·²åº”ç”¨å†³ç­–

**å®¡æŸ¥ç‰ˆæœ¬**: v0.2.0 â†’ v0.2.1 (å¾…å‘å¸ƒ)
**å®¡æŸ¥æ—¥æœŸ**: 2025-11-20
**å®¡æŸ¥äºº**: æ¶æ„å¸ˆ + ç”¨æˆ·å†³ç­–
**å®¡æŸ¥çŠ¶æ€**: âœ… å·²é€šè¿‡ - å†³ç­–å·²åº”ç”¨
**å†³ç­–åº”ç”¨æ—¥æœŸ**: 2025-11-20

---

## ğŸ¯ å†³ç­–åº”ç”¨æ‘˜è¦

æœ¬æ¬¡å®¡æŸ¥å·²æ ¹æ®ç”¨æˆ·å†³ç­–å®Œæˆä¿®æ”¹ï¼Œæ‰€æœ‰å…³é”®é—®é¢˜å·²è§£å†³ã€‚æ–‡æ¡£å·²ä» v0.2.0 å‡çº§è‡³ v0.2.1ï¼Œä¸»è¦å˜æ›´å¦‚ä¸‹ï¼š

### âœ… å·²åº”ç”¨çš„å†³ç­–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

| åºå· | é—®é¢˜æè¿° | å†³ç­– | åº”ç”¨çŠ¶æ€ | å½±å“èŒƒå›´ |
|------|----------|------|----------|----------|
| 1 | overlayå­—æ®µçŸ›ç›¾ | ç»Ÿä¸€ä¸ºPhase 01ä¸æ”¯æŒ | âœ… å·²åº”ç”¨ | åˆ é™¤æ‰€æœ‰overlayç¤ºä¾‹ |
| 2 | required_assetsæ ‡è®°å†²çª | ä¿ç•™å­—æ®µï¼Œåˆ é™¤ã€åˆ é™¤ã€‘æ ‡è®° | âœ… å·²åº”ç”¨ | å®Œå–„èµ„æºé…ç½®è¯´æ˜ |
| 3 | æ—¶é—´æˆ³æ ¼å¼ä¸ç»Ÿä¸€ | ç»Ÿä¸€ä¸ºtimestamp_ms (Unixæ¯«ç§’) | âœ… å·²åº”ç”¨ | 3.4.1èŠ‚ã€3.6èŠ‚ |
| 4 | æ¥å£å‚æ•°é¡ºåº | é«˜é¢‘å‚æ•°(pid, session)å‰ç½® | âœ… å·²åº”ç”¨ | 3.2èŠ‚æ¥å£å®šä¹‰ |
| 5 | DRYåŸåˆ™è¿å | æå–BaseResponseç»Ÿä¸€schema | âœ… å·²åº”ç”¨ | æ–°å¢3.8.6èŠ‚ |
| 6 | å­—æ®µçº¦æŸä¸æ˜ç¡® | defect_rectsé™åˆ¶20ä¸ª | âœ… å·²åº”ç”¨ | 3.8.3.3èŠ‚ |
| 7 | å‚æ•°ç±»å‹ä¸å®Œæ•´ | è¡¥å……string/array/json | âœ… å·²åº”ç”¨ | 3.2.1èŠ‚ |
| 8 | æ„é€ å‡½æ•°è§„èŒƒ | è¡¥å……ç±»å‹æ³¨è§£å’Œå±æ€§åˆå§‹åŒ– | âœ… å·²åº”ç”¨ | 3.2èŠ‚ç¤ºä¾‹ |
| 9 | ç¼ºå°‘super()è°ƒç”¨ | æ˜ç¡®é’©å­å‡½æ•°è°ƒç”¨è§„èŒƒ | âœ… å·²åº”ç”¨ | 3.2èŠ‚ç¤ºä¾‹ |
| 10 | ç¼ºå°‘ç±»å‹æ³¨è§£ | æŒ‰Google/Sphinxæ ‡å‡†è¡¥å…… | âœ… å·²åº”ç”¨ | æ‰€æœ‰ä»£ç ç¤ºä¾‹ |
| 11 | ç¼ºå°‘è¾“å…¥æ ¡éªŒ | å¢åŠ é˜²å¾¡å¼ç¼–ç¨‹ç¤ºä¾‹ | âœ… å·²åº”ç”¨ | 3.8.5èŠ‚ |
| 12 | è¾¹ç•Œåœºæ™¯è¦†ç›– | è¡¥å……15ä¸ªè¾¹ç•Œåœºæ™¯å¤„ç† | âœ… å·²åº”ç”¨ | æ–°å¢3.10èŠ‚ |
| 13 | ç¼ºå°‘é”™è¯¯ç  | å®šä¹‰7ä¸ªæ ‡å‡†é”™è¯¯ç  | âœ… å·²åº”ç”¨ | æ–°å¢3.11èŠ‚ |
| 14 | Session APIæœªå®šä¹‰ | æ˜ç¡®å®šä¹‰å®Œæ•´API | âœ… å·²åº”ç”¨ | 3.3.1èŠ‚ |

### â¸ï¸ å·²å†³å®šæš‚ç¼“çš„é¡¹

| åºå· | é—®é¢˜æè¿° | å†³ç­– | å¤‡æ³¨ |
|------|----------|------|------|
| 1 | ç¼ºå°‘å®Œæ•´ç®—æ³•ç¤ºä¾‹é¡¹ç›® | æš‚ç¼“ï¼Œåç»­å¤„ç† | è®¡åˆ’åœ¨v0.2.5æä¾›algorithm_sample/ |
| 2 | ç¼ºå°‘æ¶æ„å›¾å’Œæ—¶åºå›¾ | æš‚ç¼“ï¼Œåç»­å¤„ç† | è®¡åˆ’åœ¨v0.3.0æ·»åŠ Mermaidå›¾è¡¨ |

### âš ï¸ æ¥å—é£é™©çš„é—®é¢˜

| åºå· | é—®é¢˜æè¿° | å†³ç­– | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|----------|------|----------|----------|
| 1 | èµ„æºç®¡ç†ç¼ºä¹çº¦æŸ | æ¥å—é£é™© | ä¸­ | åœ¨v0.3.0å¢åŠ èµ„æºç›‘æ§æ¥å£ |
| 2 | åè®®æ•°æ®åŒ…å¤§å°æ— é™åˆ¶ | æ¥å—é£é™© | ä¸­ | å¢åŠ max_message_sizeé…ç½®è¯´æ˜ |

---

## ğŸ“ å·²åº”ç”¨çš„è¯¦ç»†ä¿®æ”¹

### 1. overlayå­—æ®µç»Ÿä¸€å†³ç­– âœ…

**å†³ç­–**: Phase 01 ä¸æ”¯æŒ overlayï¼Œåˆ é™¤æ‰€æœ‰ overlay ç¤ºä¾‹

**åº”ç”¨ä½ç½®**:
- spec.md:591è¡Œï¼ˆ3.8.2.5èŠ‚ï¼‰-> ä¿ç•™"Phase 01 ä¸æä¾›overlayå­—æ®µèƒ½åŠ›"
- spec.md:1174-1180è¡Œï¼ˆ3.8.5.1èŠ‚ï¼‰-> åˆ é™¤overlayé”™è¯¯ç¤ºä¾‹
- spec.md:1176-1180è¡Œ -> åˆ é™¤æ‰€æœ‰overlayç›¸å…³ä»£ç 

**ä¿®æ”¹ç»“æœ**:
```python
# âŒ å·²åˆ é™¤çš„é”™è¯¯ç¤ºä¾‹
return {
    "status": "OK",
    "data": {
        "result_status": "NG",
        "ng_reason": "æœ‰ç¼ºé™·",
        "overlay": {...}  # å·²åˆ é™¤
    }
}

# âœ… ä¿ç•™çš„æ­£ç¡®ç¤ºä¾‹
return {
    "status": "OK",
    "data": {
        "result_status": "NG",
        "ng_reason": "æœ‰ç¼ºé™·",
        "defect_rects": [...]  # åªè¿”å›åæ ‡
    }
}
```

---

### 2. required_assetså­—æ®µä¿®å¤ âœ…

**å†³ç­–**: ä¿ç•™å­—æ®µï¼Œåˆ é™¤ã€åˆ é™¤ã€‘æ ‡è®°å¹¶å®Œå–„è¯´æ˜

**åº”ç”¨ä½ç½®**:
- spec.md:12è¡Œ -> åˆ é™¤"ã€åˆ é™¤ã€‘"æ ‡è®°
- spec.md:1268-1288è¡Œ -> ä¿ç•™å¹¶å®Œå–„èµ„æºé…ç½®è¯´æ˜

**ä¿®æ”¹ç»“æœ**:
```json
{
  "name": "universal_screw_detection",
  "version": "2.0.0",
  "entry_point": "main:UniversalScrewDetector",
  "description": "é€šç”¨èºä¸æ£€æµ‹ç®—æ³•ï¼ˆæ”¯æŒA/B/Cç³»åˆ—äº§å“ï¼‰",
  "supported_pids": ["A01", "A02", "A03", "B01", "B02", "C01"],
  "required_assets": {  // âœ… ä¿ç•™å¹¶å®Œå–„è¯´æ˜
    "A01": {
      "config": "configs/A01.json",
      "template": "templates/A01_ref.jpg"
    },
    "C01": {
      "config": "configs/C01.json",
      "model": "models/model_C01.pt"
    }
  }
}
```

---

### 3. æ—¶é—´æˆ³ç»Ÿä¸€ä¸º UNIX æ¯«ç§’ âœ…

**å†³ç­–**: ç»Ÿä¸€ä½¿ç”¨ `timestamp_ms` (Unixæ¯«ç§’æ—¶é—´æˆ³)

**åº”ç”¨ä½ç½®**:
- spec.md:268è¡Œ -> `timestamp_ms`: 1714032000123
- spec.md:282è¡Œ -> å‡½æ•°è°ƒç”¨ç»Ÿä¸€ä½¿ç”¨ `timestamp_ms`
- spec.md:313è¡Œ -> åè®®ä¸­çš„ `timestamp` æ”¹ä¸º `timestamp_ms`

**ä¿®æ”¹ç»“æœ**:
```json
{
  "width": 1920,
  "height": 1200,
  "timestamp_ms": 1714032000123,  // âœ… ç»Ÿä¸€æ ¼å¼
  "camera_id": "cam-01"
}
```

---

### 4. æ¥å£å‚æ•°é¡ºåºä¼˜åŒ– âœ…

**å†³ç­–**: é«˜é¢‘å‚æ•°ï¼ˆpid, sessionï¼‰å‰ç½®ï¼Œä½é¢‘å‚æ•°ï¼ˆshared_mem_id, image_metaï¼‰åç½®

**åº”ç”¨ä½ç½®**: spec.md:102-147è¡Œæ ¸å¿ƒæ¥å£å®šä¹‰

**ä¿®æ”¹ç»“æœ**:
```python
# ä¼˜åŒ–å‰
@abstractmethod
def pre_execute(
    self,
    step_index: int,
    pid: str,
    session: "Session",
    shared_mem_id: str,
    image_meta: Dict[str, Any],
    user_params: Dict[str, Any],
) -> Dict[str, Any]: ...

# ä¼˜åŒ–å - å‚æ•°é€»è¾‘åˆ†ç»„
@abstractmethod
def pre_execute(
    self,
    step_index: int,
    pid: str,
    session: "Session",
    user_params: Dict[str, Any],
    shared_mem_id: str,
    image_meta: Dict[str, Any],
) -> Dict[str, Any]:
    """
    å‚æ•°åˆ†ç»„ï¼š
    1. æ­¥éª¤æ§åˆ¶: step_index
    2. ä¸Šä¸‹æ–‡ä¿¡æ¯: pid, session
    3. ç”¨æˆ·è¾“å…¥: user_params
    4. å›¾åƒæ•°æ®: shared_mem_id, image_meta
    """
```

---

### 5. DRYåŸåˆ™ - æå– BaseResponse Schema âœ…

**å†³ç­–**: æå–ç»Ÿä¸€çš„ `BaseResponse` schema ä½œä¸ºåŸºç±»

**åº”ç”¨ä½ç½®**: æ–°å¢ 3.8.6 èŠ‚

**æ–°å¢å†…å®¹**:
```python
### 3.8.6 ç»Ÿä¸€è¿”å›å€¼ Schema (BaseResponse)

ä¸ºé¿å…é‡å¤å®šä¹‰ï¼Œæ‰€æœ‰è¿”å›å€¼å¿…é¡»éµå¾ªä»¥ä¸‹ BaseResponse schemaï¼š

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "BaseResponse",
  "type": "object",
  "required": ["status"],
  "properties": {
    "status": {
      "type": "string",
      "enum": ["OK", "ERROR"],
      "description": "è°ƒç”¨çŠ¶æ€ï¼Œä¸¥æ ¼é™å®šä¸º OK æˆ– ERROR"
    },
    "message": {
      "type": "string",
      "description": "äººç±»å¯è¯»ä¿¡æ¯ï¼Œstatus=ERRORæ—¶å¿…é¡»æä¾›"
    },
    "data": {
      "type": "object",
      "description": "ä¸šåŠ¡æ•°æ®å¯¹è±¡ï¼Œstatus=OKæ—¶å¿…é¡»æä¾›"
    },
    "debug": {
      "type": "object",
      "description": "è°ƒè¯•ä¿¡æ¯ï¼Œå¯é€‰"
    }
  }
}
```

#### 3.8.6.1 pre_execute è¿”å›æ•°æ®å¯¹è±¡

å½“ `status="OK"` æ—¶ï¼Œ`data` å¯¹è±¡åŒ…å«ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | æè¿° |
|------|------|------|------|
| `calibration_rects` | array | å¦ | æ ‡å®šæ¡†åˆ—è¡¨ |
| `debug` | object | å¦ | è°ƒè¯•ä¿¡æ¯ |

#### 3.8.6.2 execute è¿”å›æ•°æ®å¯¹è±¡

å½“ `status="OK"` æ—¶ï¼Œ`data` å¯¹è±¡åŒ…å«ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | æè¿° |
|------|------|------|------|
| `result_status` | string | æ˜¯ | ä¸šåŠ¡çŠ¶æ€ï¼š"OK"æˆ–"NG" |
| `ng_reason` | string | NGæ—¶å¿…å¡« | ä¸åˆæ ¼åŸå›  |
| `defect_rects` | array | NGæ—¶å¿…å¡« | ç¼ºé™·æ¡†åˆ—è¡¨ |
| `position_rects` | array | å¦ | å®šä½æ¡†åˆ—è¡¨ |
| `diagnostics` | object | å¼ºçƒˆæ¨è | è¯Šæ–­æ•°æ® |
| `debug` | object | å¦ | è°ƒè¯•ä¿¡æ¯ |
```

---

### 6. å­—æ®µçº¦æŸæ˜ç¡®åŒ– âœ…

**å†³ç­–**: æ˜ç¡®å®šä¹‰ `defect_rects` é™åˆ¶ 20 ä¸ªå…ƒç´ ä»¥å†…

**åº”ç”¨ä½ç½®**: spec.md:273è¡Œè¡¨æ ¼ï¼Œ3.8.3.3èŠ‚

**ä¿®æ”¹ç»“æœ**:
```python
# å­—æ®µçº¦æŸè¡¨ï¼ˆspec.md:273è¡Œï¼‰
| å­—æ®µ               | é—®é¢˜æè¿°                     | çº¦æŸå®šä¹‰                         |
| ------------------ | ---------------------------- | -------------------------------- |
| `supported_pids` | ä»…å»ºè®®ä¸è¶…è¿‡20ä¸ª             | å»ºè®®â‰¤20ä¸ªï¼Œæœ€å¤§50ä¸ªï¼ˆæ€§èƒ½å½±å“ï¼‰  |
| `defect_rects`   | æœªå®šä¹‰æœ€å¤§é•¿åº¦               | âœ… **é™åˆ¶20ä¸ªæ¡†å…ƒç´ ä»¥å†…**        |
| `message`        | å»ºè®®<100å­—ç¬¦                 | Dev Runnerä¸­å¢åŠ é•¿åº¦æ ¡éªŒï¼ˆ100ï¼‰  |
| ROIåæ ‡          | æœªå®šä¹‰åæ ‡ç³»                 | å·¦ä¸Šè§’åŸç‚¹ï¼Œx,yâ‰¥0                |
```

---

### 7. å‚æ•°ç±»å‹ç³»ç»Ÿè¡¥å…… âœ…

**å†³ç­–**: è¡¥å…… `string`, `array`, `json` ç±»å‹

**åº”ç”¨ä½ç½®**: spec.md:301-311è¡Œï¼Œ3.2.1èŠ‚

**ä¿®æ”¹ç»“æœ**:
```python
#### 3.2.1.1 å‚æ•°ç±»å‹å®šä¹‰

æ”¯æŒçš„å‚æ•°ç±»å‹åŒ…æ‹¬ï¼š

```python
param_types = {
    "int": {
        "has_min_max": True,
        "unit": "å¯é€‰å•ä½è¯´æ˜"
    },
    "float": {
        "has_min_max": True,
        "unit": "å»ºè®®æä¾›å•ä½ï¼ˆå¦‚ms, luxï¼‰"
    },
    "rect": {
        "has_min_max": False,
        "format": "x,y,width,height",
        "description": "çŸ©å½¢åŒºåŸŸï¼Œå·¦ä¸Šè§’åŸç‚¹"
    },
    "enum": {
        "has_choices": True,
        "choices": ["value1", "value2"]
    },
    "bool": {
        "has_min_max": False
    },
    "string": {  // âœ… æ–°å¢
        "has_min_max": True,
        "min_length": 1,
        "max_length": 1000,
        "pattern": "å¯é€‰æ­£åˆ™è¡¨è¾¾å¼"
    },
    "array": {  // âœ… æ–°å¢
        "item_type": "å…ƒç´ ç±»å‹ï¼ˆint/float/stringï¼‰",
        "min_length": 0,
        "max_length": 100
    },
    "json": {  // âœ… æ–°å¢
        "schema": "JSON Schemaå®šä¹‰"
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# stringç±»å‹
{
    "key": "model_path",
    "type": "string",
    "description": "æ¨¡å‹æ–‡ä»¶è·¯å¾„"
}

# arrayç±»å‹
{
    "key": "rois",
    "type": "array",
    "item_type": "rect",
    "max_length": 10
}

# jsonç±»å‹ï¼ˆå¤æ‚é…ç½®ï¼‰
{
    "key": "advanced_config",
    "type": "json",
    "schema": {...}
}
```
```

---

### 8. æ„é€ å‡½æ•°è§„èŒƒå®Œå–„ âœ…

**å†³ç­–**: è¡¥å……ç±»å‹æ³¨è§£å’Œå±æ€§åˆå§‹åŒ–

**åº”ç”¨ä½ç½®**: spec.md:64-69è¡Œ

**ä¿®æ”¹ç»“æœ**:
```python
# ä¿®æ”¹å‰
def __init__(self):
    """æ„é€ å‡½æ•°..."""
    pass  # âŒ ç¼ºå°‘ç±»å‹æ³¨è§£å’Œå±æ€§åˆå§‹åŒ–

# âœ… ä¿®æ”¹å
def __init__(self) -> None:
    """æ„é€ å‡½æ•°ã€‚åœ¨ç®—æ³•å®ä¾‹åˆ›å»ºæ—¶è°ƒç”¨ã€‚

    æ³¨æ„ï¼š
        - ç®—æ³•å®ä¾‹ä¸ç»‘å®šå…·ä½“PIDï¼Œéœ€æ”¯æŒæ‰€æœ‰supported_pidsä¸­çš„å‹å·
        - åœ¨æ­¤åˆå§‹åŒ–è½»é‡çº§èµ„æºï¼ˆé…ç½®ã€è·¯å¾„ç­‰ï¼‰
        - é‡é‡çº§èµ„æºï¼ˆæ¨¡å‹ã€æ˜¾å­˜ï¼‰åº”åœ¨setup()ä¸­åˆå§‹åŒ–

    ç¤ºä¾‹ï¼š
        >>> class MyAlgo(BaseAlgorithm):
        ...     def __init__(self) -> None:
        ...         self.configs = {}  # é…ç½®ç¼“å­˜
        ...         self.model = None  # æ¨¡å‹å ä½ç¬¦
    """
    self._resources_loaded: bool = False
    self._model_version: Optional[str] = None
    # ... å…¶ä»–å±æ€§åˆå§‹åŒ–
```

---

### 9. ç”Ÿå‘½å‘¨æœŸé’©å­ super() è°ƒç”¨ âœ…

**å†³ç­–**: æ˜ç¡®é’©å­å‡½æ•°æ˜¯å¦éœ€è¦ super() è°ƒç”¨

**åº”ç”¨ä½ç½®**: spec.md:72-90èŠ‚ï¼Œæ–°å¢è¯´æ˜

**ä¿®æ”¹ç»“æœ**:
```python
class BaseAlgorithm(ABC):
    # ...

    def setup(self) -> None:
        """ç®—æ³•å®ä¾‹å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡ã€‚

        è¯´æ˜ï¼š
            - å¯é€‰å®ç°ï¼Œéå¼ºåˆ¶
            - å¦‚éœ€æ‰©å±•çˆ¶ç±»è¡Œä¸ºï¼Œè¯·å…ˆè°ƒç”¨ super().setup()
            - ç”¨äºåŠ è½½æ¨¡å‹ã€å»ºç«‹å…±äº«å†…å­˜/æ˜¾å­˜æ± ç­‰é‡é‡çº§åˆå§‹åŒ–

        ç¤ºä¾‹ï¼š
            >>> def setup(self) -> None:
            ...     super().setup()  # âœ… å¦‚éœ€ç»§æ‰¿çˆ¶ç±»è¡Œä¸º
            ...     self.model = self._load_model()
        """
        return None

    def teardown(self) -> None:
        """ç®—æ³•å®ä¾‹é”€æ¯å‰è°ƒç”¨ä¸€æ¬¡ã€‚

        è¯´æ˜ï¼š
            - å¯é€‰å®ç°ï¼Œéå¼ºåˆ¶
            - å¦‚éœ€æ‰©å±•çˆ¶ç±»è¡Œä¸ºï¼Œè¯·å…ˆè°ƒç”¨ super().teardown()
            - ç”¨äºé‡Šæ”¾æ¨¡å‹ã€æ˜¾å­˜ã€å…±äº«å†…å­˜ã€åå°çº¿ç¨‹/è¿æ¥
        """
        return None

    def reset(self, session: "Session") -> None:
        """å½“å¹³å°è§¦å‘é‡æ–°æ£€æµ‹/ä¸­æ–­æ—¶è°ƒç”¨ã€‚

        è¯´æ˜ï¼š
            - å¯é€‰å®ç°ï¼Œéå¼ºåˆ¶
            - ç”¨äºæ¸…ç†æœ¬æ¬¡æ£€æµ‹ç›¸å…³ä¸´æ—¶èµ„æºï¼Œé¿å…è„æ•°æ®
            - ä¸è¦åœ¨æ­¤é‡Šæ”¾æ¨¡å‹ç­‰è·¨ä¼šè¯èµ„æºï¼ˆåº”åœ¨teardownä¸­ï¼‰
        """
        return None
```

**è°ƒç”¨è¦æ±‚**:
- âœ… `__init__()`: **å¿…é¡»**è°ƒç”¨ `super().__init__()`
- âœ… `setup()`: å¦‚éœ€ç»§æ‰¿çˆ¶ç±»è¡Œä¸ºï¼Œ**å¿…é¡»**è°ƒç”¨ `super().setup()`
- âœ… `teardown()`: å¦‚éœ€ç»§æ‰¿çˆ¶ç±»è¡Œä¸ºï¼Œ**å¿…é¡»**è°ƒç”¨ `super().teardown()`
- âœ… `reset()`: å¦‚éœ€ç»§æ‰¿çˆ¶ç±»è¡Œä¸ºï¼Œ**å¿…é¡»**è°ƒç”¨ `super().reset(session)`

---

### 10. ç±»å‹æ³¨è§£æ ‡å‡†åŒ– âœ…

**å†³ç­–**: æŒ‰ Google/Sphinx æ ‡å‡†è¡¥å……æ‰€æœ‰ä»£ç ç¤ºä¾‹

**åº”ç”¨èŒƒå›´**: spec.md ä¸­æ‰€æœ‰ä»£ç ç¤ºä¾‹

**ä¿®æ”¹ç¤ºä¾‹**:
```python
# âŒ ä¿®æ”¹å‰
def check_brightness(img):
    return np.mean(img)

# âœ… ä¿®æ”¹å
def check_brightness(img: np.ndarray) -> float:
    """æ£€æŸ¥å›¾åƒäº®åº¦ã€‚

    Args:
        img: è¾“å…¥å›¾åƒï¼Œå½¢çŠ¶ä¸º(H, W, C)çš„numpyæ•°ç»„.
            H: é«˜åº¦
            W: å®½åº¦
            C: é€šé“æ•°ï¼ˆRGBä¸º3ï¼‰

    Returns:
        å¹³å‡äº®åº¦å€¼ï¼ˆ0.0-255.0ï¼‰

    Raises:
        ValueError: å½“è¾“å…¥å›¾åƒä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®æ—¶
        TypeError: å½“è¾“å…¥ä¸æ˜¯numpyæ•°ç»„æ—¶

    Example:
        >>> img = np.random.randint(0, 255, (480, 640, 3), dtype=np.uint8)
        >>> brightness = check_brightness(img)
        >>> 0.0 <= brightness <= 255.0
        True

    Note:
        - è¯¥æ–¹æ³•è®¡ç®—å…¨å›¾RGBä¸‰ä¸ªé€šé“çš„å¹³å‡å€¼
        - é€‚ç”¨äºå…‰ç…§å‡åŒ€æ€§æ£€æŸ¥
        - å¯¹äºRGBå›¾åƒï¼Œè¿”å›å€¼èŒƒå›´æ˜¯0-255
    """
    if img is None:
        raise ValueError("è¾“å…¥å›¾åƒä¸èƒ½ä¸ºNone")

    if not isinstance(img, np.ndarray):
        raise TypeError(f"æœŸæœ›numpyæ•°ç»„ï¼Œå¾—åˆ°{type(img)}")

    if img.size == 0:
        raise ValueError("è¾“å…¥å›¾åƒä¸ºç©ºæ•°ç»„")

    return float(np.mean(img))
```

---

### 11. è¾“å…¥æ ¡éªŒå’Œé˜²å¾¡å¼ç¼–ç¨‹ âœ…

**å†³ç­–**: å¢åŠ é˜²å¾¡å¼ç¼–ç¨‹ç¤ºä¾‹

**åº”ç”¨ä½ç½®**: æ–°å¢ 3.8.7 èŠ‚"é˜²å¾¡å¼ç¼–ç¨‹æœ€ä½³å®è·µ"

**æ–°å¢å†…å®¹**:
```python
### 3.8.7 é˜²å¾¡å¼ç¼–ç¨‹æœ€ä½³å®è·µ

ä¸ºå¢å¼ºç®—æ³•å¥å£®æ€§ï¼Œå»ºè®®åœ¨execute/pre_executeä¸­å¢åŠ è¾“å…¥æ ¡éªŒï¼š

#### 3.8.7.1 å›¾åƒè¾“å…¥æ ¡éªŒ

```python
def execute(
    self,
    step_index: int,
    pid: str,
    session: "Session",
    user_params: Dict[str, Any],
    shared_mem_id: str,
    image_meta: Dict[str, Any]
) -> Dict[str, Any]:
    """æ‰§è¡Œæ£€æµ‹é€»è¾‘ï¼ˆå«è¾“å…¥æ ¡éªŒç¤ºä¾‹ï¼‰ã€‚"""

    # 1. éªŒè¯PIDæ”¯æŒ
    if pid not in self._supported_pids:
        return {
            "status": "ERROR",
            "message": f"ä¸æ”¯æŒçš„äº§å“å‹å·: {pid}",
            "error_code": "1001"
        }

    # 2. éªŒè¯image_metaå¿…éœ€å­—æ®µ
    required_fields = ["width", "height", "timestamp_ms", "camera_id"]
    for field in required_fields:
        if field not in image_meta:
            return {
                "status": "ERROR",
                "message": f"image_metaç¼ºå°‘å¿…éœ€å­—æ®µ: {field}",
                "error_code": "1006"
            }

    # 3. éªŒè¯å›¾åƒå°ºå¯¸åˆç†æ€§
    width = image_meta["width"]
    height = image_meta["height"]
    if not (100 <= width <= 8000 and 100 <= height <= 8000):
        return {
            "status": "ERROR",
            "message": f"å›¾åƒå°ºå¯¸ä¸åˆç†: {width}x{height}",
            "error_code": "1006"
        }

    # 4. éªŒè¯shared_mem_id
    if not shared_mem_id or len(shared_mem_id) < 8:
        return {
            "status": "ERROR",
            "message": "æ— æ•ˆçš„å…±äº«å†…å­˜ID",
            "error_code": "1002"
        }

    # 5. éªŒè¯user_paramsï¼ˆæ ¹æ®schemaï¼‰
    schema = self._get_param_schema(step_index)
    validation_result = self._validate_params(user_params, schema)
    if not validation_result["valid"]:
        return {
            "status": "ERROR",
            "message": f"å‚æ•°æ ¡éªŒå¤±è´¥: {validation_result['errors']}",
            "error_code": "1006"
        }

    # æ‰§è¡Œæ£€æµ‹é€»è¾‘
    try:
        img = read_image_from_shared_memory(shared_mem_id, image_meta)

        # éªŒè¯å›¾åƒä¸ä¸ºç©º
        if img is None or img.size == 0:
            return {
                "status": "ERROR",
                "message": "å›¾åƒæ•°æ®ä¸ºç©º",
                "error_code": "1002"
            }

        # æ ¸å¿ƒæ£€æµ‹é€»è¾‘...
        result = self._detect(img, user_params)

        return {
            "status": "OK",
            "data": {
                "result_status": "OK" if result.ok else "NG",
                "ng_reason": result.reason,
                "defect_rects": result.boxes[:20],  # é™åˆ¶æœ€å¤§æ•°é‡
                "diagnostics": result.diagnostics
            }
        }

    except GPUOutOfMemoryError as e:
        return {
            "status": "ERROR",
            "message": f"GPUæ˜¾å­˜ä¸è¶³: {e}",
            "error_code": "1004"
        }

    except Exception as e:
        self.logger.error(f"æ£€æµ‹å¼‚å¸¸: {e}", exc_info=True)
        return {
            "status": "ERROR",
            "message": f"æ£€æµ‹å¤±è´¥: {str(e)}",
            "error_code": "9999"
        }
```

#### 3.8.7.2 è¿”å›å€¼æ•°æ®æ ¡éªŒ

```python
def _validate_return_value(self, result: Dict[str, Any]) -> bool:
    """æ ¡éªŒè¿”å›å€¼æ ¼å¼ã€‚"""
    # 1. æ£€æŸ¥å¿…éœ€å­—æ®µ
    if "status" not in result:
        self.logger.error("è¿”å›å€¼ç¼ºå°‘statuså­—æ®µ")
        return False

    # 2. æ£€æŸ¥statuså–å€¼
    if result["status"] not in ["OK", "ERROR"]:
        self.logger.error(f"statuså–å€¼æ— æ•ˆ: {result['status']}")
        return False

    # 3. ERRORæ—¶å¿…é¡»æœ‰message
    if result["status"] == "ERROR":
        if "message" not in result or not result["message"]:
            self.logger.error("ERRORçŠ¶æ€ç¼ºå°‘messageå­—æ®µ")
            return False

    # 4. OKæ—¶å¿…é¡»æœ‰data
    if result["status"] == "OK":
        if "data" not in result or not isinstance(result["data"], dict):
            self.logger.error("OKçŠ¶æ€ç¼ºå°‘dataå­—æ®µæˆ–ç±»å‹é”™è¯¯")
            return False

        data = result["data"]

        # 5. executeè¿”å›å¿…é¡»æœ‰result_status
        if "result_status" in data:
            if data["result_status"] not in ["OK", "NG"]:
                self.logger.error(f"result_statuså–å€¼é”™è¯¯: {data['result_status']}")
                return False

            # 6. NGæ—¶å¿…é¡»æœ‰ng_reasonå’Œdefect_rects
            if data["result_status"] == "NG":
                if "ng_reason" not in data:
                    self.logger.error("NGçŠ¶æ€ç¼ºå°‘ng_reasonå­—æ®µ")
                    return False

                if "defect_rects" not in data:
                    self.logger.error("NGçŠ¶æ€ç¼ºå°‘defect_rectså­—æ®µ")
                    return False

                # 7. defect_rectsæ•°é‡é™åˆ¶
                if len(data["defect_rects"]) > 20:
                    self.logger.warning(f"defect_rectsæ•°é‡è¶…è¿‡é™åˆ¶: {len(data['defect_rects'])}")
                    data["defect_rects"] = data["defect_rects"][:20]

    return True
```
```

---

### 12. è¾¹ç•Œåœºæ™¯è¦†ç›–è¡¨ âœ…

**å†³ç­–**: è¡¥å……å®Œæ•´çš„è¾¹ç•Œåœºæ™¯å¤„ç†è¯´æ˜

**åº”ç”¨ä½ç½®**: æ–°å¢ 3.10 èŠ‚

**æ–°å¢å†…å®¹**:
```python
## 3.10 è¾¹ç•Œåœºæ™¯å¤„ç†æŒ‡å—

### 3.10.1 è¾¹ç•Œåœºæ™¯è¦†ç›–è¡¨

| åœºæ™¯åˆ†ç±» | å…·ä½“åœºæ™¯ | å¤„ç†å»ºè®® | æ¨èé”™è¯¯ç  |
|----------|----------|----------|------------|
| **å›¾åƒè¾“å…¥** | 1. shared_mem_idæ— æ•ˆ/ä¸å­˜åœ¨ | è¿”å›ERRORï¼Œæ£€æŸ¥IDæ˜¯å¦æ­£ç¡® | 1002 |
| | 2. image_metaç¼ºå°‘å¿…éœ€å­—æ®µ | è¿”å›ERRORï¼Œåˆ—å‡ºç¼ºå¤±å­—æ®µ | 1006 |
| | 3. å›¾åƒå°ºå¯¸è¶…å‡ºåˆç†èŒƒå›´ | è¿”å›ERRORï¼Œå»ºè®®è°ƒæ•´ç›¸æœºå‚æ•° | 1006 |
| | 4. å›¾åƒè§£ç å¤±è´¥ | è¿”å›ERRORï¼Œæ£€æŸ¥å›¾åƒå®Œæ•´æ€§ | 1002 |
| | 5. å›¾åƒä¸ºç©ºæˆ–å…¨é»‘ | è¿”å›ERRORï¼Œæç¤ºæ£€æŸ¥å…‰æº | 1002 |
| **å‚æ•°è¾“å…¥** | 6. user_paramsç¼ºå°‘requiredå­—æ®µ | è¿”å›ERRORï¼Œåˆ—å‡ºå¿…éœ€å­—æ®µ | 1006 |
| | 7. user_paramsç±»å‹ä¸åŒ¹é… | å°è¯•è½¬æ¢æˆ–è¿”å›ERROR | 1006 |
| | 8. paramsè¶…å‡ºmin/maxèŒƒå›´ | è¿”å›ERRORæˆ–è‡ªåŠ¨æˆªæ–­ï¼ˆéœ€æ—¥å¿—è­¦å‘Šï¼‰ | 1006 |
| | 9. ROIåæ ‡è¶Šç•Œ | è¿”å›ERRORï¼Œåæ ‡å¿…é¡»åœ¨å›¾åƒèŒƒå›´å†… | 1007 |
| **PIDç›¸å…³** | 10. pidä¸åœ¨supported_pidsä¸­ | è¿”å›ERRORï¼Œæç¤ºæ£€æŸ¥manifest.json | 1001 |
| | 11. required_assetsç¼ºå°‘pidé…ç½® | åœ¨setup()æ—¶éªŒè¯å¹¶æŠ›å‡ºå¼‚å¸¸ | 1003 |
| | 12. é…ç½®åŠ è½½å¤±è´¥ | è¿”å›ERRORï¼Œè®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ | 1003 |
| **èµ„æºç®¡ç†** | 13. æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨ | åœ¨setup()æ—¶éªŒè¯ï¼Œå¯åŠ¨å¤±è´¥ | 1003 |
| | 14. GPUæ˜¾å­˜ä¸è¶³ï¼ˆOOMï¼‰ | è¿”å›ERRORï¼Œé‡Šæ”¾èµ„æºåé‡è¯• | 1004 |
| | 15. æ–‡ä»¶å¥æŸ„æ³„æ¼ | åœ¨teardown()ä¸­æ¸…ç†ï¼Œå¢åŠ ç›‘æ§å‘Šè­¦ | - |
| **å¹¶å‘ä¸è¶…æ—¶** | 16. pre_executeè¶…æ—¶ï¼ˆ>10ç§’ï¼‰ | Runnerå¼ºåˆ¶ç»ˆæ­¢ï¼Œè¿”å›TIMEOUT | 1005 |
| | 17. executeè¶…æ—¶ï¼ˆ>30ç§’ï¼‰ | Runnerå¼ºåˆ¶ç»ˆæ­¢ï¼Œè¿”å›TIMEOUT | 1005 |
| | 18. å¿ƒè·³ä¸¢å¤± | Runnerè®°å½•æ—¥å¿—ï¼Œé‡è¯•æˆ–é‡å¯è¿›ç¨‹ | - |
| | 19. è¿›ç¨‹å´©æºƒ | Runnerè‡ªåŠ¨é‡å¯ï¼Œè®°å½•æ—¥å¿— | - |
| **é€šä¿¡åè®®** | 20. JSONè§£æå¤±è´¥ | è¿”å›ERROR frameï¼Œåè®®æ ¼å¼é”™è¯¯ | - |
| | 21. æ¶ˆæ¯ç²˜åŒ…/åŠåŒ… | æ ¡éªŒ4å­—èŠ‚é•¿åº¦å­—æ®µï¼Œé‡è¯•æˆ–æŠ¥é”™ | - |
| | 22. åè®®ç‰ˆæœ¬ä¸å…¼å®¹ | helloæ¡æ‰‹æ—¶æ ¡éªŒï¼Œæ˜ç¡®æŠ¥é”™ | - |
| **è¿”å›å€¼** | 23. defect_rectsæ•°é‡è¿‡å¤šï¼ˆ>20ï¼‰ | è‡ªåŠ¨æˆªæ–­å¹¶è®°å½•è­¦å‘Š | - |
| | 24. è¿”å›åæ ‡è¶Šç•Œ | åœ¨ç®—æ³•å†…æ ¡éªŒï¼Œè¿”å›ERRORæˆ–ä¿®æ­£ | 1007 |
| | 25. è¿”å›å€¼ç¼ºå°‘å¿…éœ€å­—æ®µ | Dev Runnerä¸­æ ¡éªŒå¹¶æç¤º | 1006 |
| | 26. result_statuså–å€¼é”™è¯¯ | Dev Runnerä¸­æ ¡éªŒå¹¶æç¤º | 1006 |
```

---

### 13. é”™è¯¯ç è¡¨ âœ…

**å†³ç­–**: ç»Ÿä¸€å®šä¹‰é”™è¯¯ç è¡¨

**åº”ç”¨ä½ç½®**: æ–°å¢ 3.11 èŠ‚

**æ–°å¢å†…å®¹**:
```python
## 3.11 æ ‡å‡†é”™è¯¯ç å®šä¹‰

### 3.11.1 é”™è¯¯ç ç»“æ„

```json
{
  "status": "ERROR",
  "message": "äººç±»å¯è¯»çš„é”™è¯¯æè¿°",
  "error_code": "å››ä½æ•°å­—ç¼–ç ",
  "debug": {}
}
```

### 3.11.2 é”™è¯¯ç è¡¨

| é”™è¯¯ç  | é”™è¯¯ç±»å‹ | è¯´æ˜ | è§¦å‘åœºæ™¯ | æ¨èå¤„ç† |
|--------|----------|------|----------|----------|
| **1001** | invalid_pid | ä¸æ”¯æŒçš„äº§å“å‹å· | pidä¸åœ¨supported_pidsä¸­ | è¿”å›ERRORï¼Œæç¤ºæ£€æŸ¥manifest.json |
| **1002** | image_load_failed | å›¾åƒåŠ è½½å¤±è´¥ | shared_mem_idæ— æ•ˆã€å›¾åƒè§£ç å¤±è´¥ | è¿”å›ERRORï¼Œæ£€æŸ¥å›¾åƒæº |
| **1003** | model_not_found | æ¨¡å‹/é…ç½®ä¸å­˜åœ¨ | æ¨¡å‹æ–‡ä»¶è·¯å¾„é”™è¯¯ã€é…ç½®ç¼ºå¤± | setup()æ—¶éªŒè¯ï¼Œè¿”å›ERROR |
| **1004** | gpu_oom | GPUæ˜¾å­˜ä¸è¶³ | GPUå†…å­˜è€—å°½ | é‡Šæ”¾èµ„æºåé‡è¯•ï¼Œæˆ–æç¤ºç¡¬ä»¶å‡çº§ |
| **1005** | timeout | æ‰§è¡Œè¶…æ—¶ | execute>30ç§’ã€pre_execute>10ç§’ | Runnerå¼ºåˆ¶ç»ˆæ­¢ï¼Œè®°å½•æ—¥å¿— |
| **1006** | invalid_params | å‚æ•°æ ¡éªŒå¤±è´¥ | ç¼ºå°‘requiredå­—æ®µã€ç±»å‹é”™è¯¯ã€è¶…å‡ºèŒƒå›´ | è¿”å›ERRORï¼Œè¯´æ˜å…·ä½“å­—æ®µ |
| **1007** | coordinate_invalid | åæ ‡è¶Šç•Œ | è¿”å›çš„åæ ‡è¶…å‡ºå›¾åƒèŒƒå›´ | ç®—æ³•å†…æ ¡éªŒï¼Œè¿”å›ERRORæˆ–ä¿®æ­£ |
| **9999** | unknown_error | æœªçŸ¥é”™è¯¯ | æœªé¢„æœŸçš„å¼‚å¸¸ | è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œè¿”å›é€šç”¨é”™è¯¯ |

### 3.11.3 ä½¿ç”¨ç¤ºä¾‹

```python
def execute(self, ...) -> Dict[str, Any]:
    try:
        # éªŒè¯PID
        if pid not in self.supported_pids:
            return {
                "status": "ERROR",
                "message": f"ä¸æ”¯æŒçš„äº§å“å‹å·: {pid}",
                "error_code": "1001",
                "debug": {"supported_pids": self.supported_pids}
            }

        # ... æ‰§è¡Œä¸šåŠ¡é€»è¾‘

    except GPUOutOfMemoryError as e:
        return {
            "status": "ERROR",
            "message": f"GPUæ˜¾å­˜ä¸è¶³: {e}",
            "error_code": "1004",
            "debug": {"gpu_memory_mb": torch.cuda.memory_allocated()}
        }

    except Exception as e:
        self.logger.error("æœªçŸ¥é”™è¯¯", exc_info=True)
        return {
            "status": "ERROR",
            "message": f"æ£€æµ‹å¤±è´¥: {str(e)}",
            "error_code": "9999",
            "debug": {"exception": str(e)}
        }
```

**æ³¨æ„**ï¼š
- error_code ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œä¾¿äº JSON ä¼ è¾“
- ä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚ status="NG"ï¼‰ä¸ä½¿ç”¨ error_code
- Runner ç›‘æ§åˆ°è¶…æ—¶ï¼ˆ1005ï¼‰æ—¶è‡ªåŠ¨ç»ˆæ­¢è¿›ç¨‹
- Dev Runner åº”åœ¨å¼€å‘é˜¶æ®µæ ¡éªŒæ‰€æœ‰é”™è¯¯ç ä½¿ç”¨
```

---

### 14. Session API å®Œæ•´å®šä¹‰ âœ…

**å†³ç­–**: æ˜ç¡®å®šä¹‰ Session å¯¹è±¡çš„å®Œæ•´ API

**åº”ç”¨ä½ç½®**: spec.md:233-251è¡Œï¼Œæ–°å¢ 3.3.1 èŠ‚

**ä¿®æ”¹ç»“æœ**:
```python
### 3.3 Session ä¸çŠ¶æ€å…±äº«

SDKåœ¨æ¯æ¬¡å·¥è‰ºæµç¨‹å¼€å§‹æ—¶åˆ›å»º `Session` å¯¹è±¡ï¼Œå¹¶åœ¨æ•´ä¸ªæµç¨‹ä¸­é€ä¼ ç»™ `pre_execute` / `execute` / ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚

#### 3.3.1 Session API å®šä¹‰

```python
class Session:
    """ä¼šè¯ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨äºè·¨æ­¥éª¤æ•°æ®å…±äº«ã€‚"""

    @property
    def id(self) -> str:
        """ä¼šè¯å”¯ä¸€æ ‡è¯†ã€‚"""
        return self._id

    @property
    def context(self) -> Dict[str, Any]:
        """åªè¯»ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆäº§å“ä¿¡æ¯ã€æ“ä½œå‘˜ç­‰ï¼‰ã€‚"""
        return self._context.copy()

    def get(self, key: str, default: Any = None) -> Any:
        """
        è·å–ä¼šè¯å­˜å‚¨ä¸­çš„å€¼ã€‚

        Args:
            key: é”®å
            default: é»˜è®¤å€¼ï¼ˆä¸å­˜åœ¨æ—¶è¿”å›ï¼‰

        Returns:
            å­˜å‚¨çš„å€¼æˆ–é»˜è®¤å€¼

        ç¤ºä¾‹ï¼š
            >>> value = session.get("alignment_template")
            >>> count = session.get("retry_count", 0)
        """
        return self._state_store.get(key, default)

    def set(self, key: str, value: Any, ttl: Optional[int] = None) -> None:
        """
        è®¾ç½®ä¼šè¯å­˜å‚¨ä¸­çš„å€¼ã€‚

        Args:
            key: é”®å
            value: å€¼ï¼ˆå¿…é¡»æ˜¯JSONå¯åºåˆ—åŒ–çš„ï¼‰
            ttl: å¯é€‰çš„ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼ŒNoneè¡¨ç¤ºæ°¸ä¹…

        Raises:
            TypeError: å½“valueä¸æ˜¯JSONå¯åºåˆ—åŒ–æ—¶

        ç¤ºä¾‹ï¼š
            >>> session.set("template", template_image)
            >>> session.set("timestamp", time.time(), ttl=60)
        """
        # éªŒè¯å¯åºåˆ—åŒ–
        try:
            json.dumps(value)
        except (TypeError, ValueError):
            raise TypeError(f"å€¼å¿…é¡»æ˜¯JSONå¯åºåˆ—åŒ–çš„: {type(value)}")

        self._state_store[key] = value

        # è®¾ç½®TTL
        if ttl is not None:
            self._ttl[key] = time.time() + ttl

    def delete(self, key: str) -> bool:
        """
        åˆ é™¤ä¼šè¯å­˜å‚¨ä¸­çš„å€¼ã€‚

        Args:
            key: é”®å

        Returns:
            æˆåŠŸè¿”å›Trueï¼Œä¸å­˜åœ¨è¿”å›False
        """
        if key in self._state_store:
            del self._state_store[key]
            self._ttl.pop(key, None)
            return True
        return False

    def reset(self) -> None:
        """
        æ¸…ç©ºæ‰€æœ‰ä¼šè¯å­˜å‚¨æ•°æ®ã€‚

        è°ƒç”¨æ—¶æœºï¼š
            - å¹³å°è§¦å‘é‡æ–°æ£€æµ‹
            - æ£€æµ‹æµç¨‹ä¸­æ–­
            - ç”¨æˆ·æ‰‹åŠ¨é‡ç½®
        """
        self._state_store.clear()
        self._ttl.clear()

    def get_all(self) -> Dict[str, Any]:
        """è·å–æ‰€æœ‰ä¼šè¯å­˜å‚¨æ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰ã€‚"""
        return self._state_store.copy()

    def exists(self, key: str) -> bool:
        """æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ã€‚"""
        return key in self._state_store

    def increment(self, key: str, delta: int = 1) -> int:
        """
        åŸå­é€’å¢è®¡æ•°å™¨ã€‚

        Args:
            key: é”®å
            delta: å¢é‡

        Returns:
            é€’å¢åçš„å€¼
        """
        current = self.get(key, 0)
        new_value = current + delta
        self.set(key, new_value)
        return new_value

    def decrement(self, key: str, delta: int = 1) -> int:
        """åŸå­é€’å‡è®¡æ•°å™¨ã€‚"""
        return self.increment(key, -delta)
```

#### 3.3.2 Session ä½¿ç”¨ç¤ºä¾‹

```python
def pre_execute(self, step_index, pid, session, user_params, shared_mem_id, image_meta):
    """ä½¿ç”¨Sessionå…±äº«æ•°æ®ç¤ºä¾‹ã€‚"""

    # 1. è¯»å–ä¹‹å‰æ­¥éª¤çš„ç»“æœ
    template = session.get("template")
    if template is None:
        return {
            "status": "ERROR",
            "message": "æœªæ‰¾åˆ°æ¨¡æ¿ï¼Œè¯·å…ˆæ‰§è¡Œæ¨¡æ¿åŒ¹é…æ­¥éª¤"
        }

    # 2. å­˜å‚¨å½“å‰æ­¥éª¤ç»“æœ
    alignment_result = self._align(image, template)
    session.set("alignment", alignment_result)

    # 3. è®¡æ•°å™¨ç”¨æ³•ï¼ˆç»Ÿè®¡é‡è¯•æ¬¡æ•°ï¼‰
    retry_count = session.increment("retry_count")
    if retry_count > 3:
        session.reset()  # é‡ç½®ä¼šè¯

    # 4. TTLç”¨æ³•ï¼ˆä¸´æ—¶æ•°æ®è‡ªåŠ¨è¿‡æœŸï¼‰
    session.set("temp_data", value, ttl=60)  # 60ç§’åè‡ªåŠ¨åˆ é™¤

    return {
        "status": "OK",
        "data": {"alignment": alignment_result}
    }
```

#### 3.3.3 Session ç”Ÿå‘½å‘¨æœŸ

```
å¹³å°åˆ›å»ºSession
    â†“
[setup()] - åªåœ¨ç®—æ³•å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡
    â†“
[pre_execute(step=0)] â†’ [execute(step=0)]  â†’  [Sessionæ•°æ®æŒä¹…åŒ–]
    â†“                                           â†“
[pre_execute(step=1)] â†’ [execute(step=1)]  â†’  [Sessionæ•°æ®æŒä¹…åŒ–]
    â†“                                           â†“
               ...ï¼ˆæ›´å¤šæ­¥éª¤ï¼‰...
    â†“                                           â†“
[on_step_finish()] - æ¯æ­¥ç»“æŸåè°ƒç”¨
    â†“
å¹³å°ç»“æŸSessionï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
    â†“
[teardown()] - å¯é€‰ï¼Œè¿›ç¨‹é€€å‡ºå‰è°ƒç”¨
    â†“
è¿›ç¨‹é€€å‡º
```

**é‡è¦çº¦æŸ**ï¼š
- Sessionæ•°æ®ä»…åœ¨**å•æ¬¡æ£€æµ‹æµç¨‹**å†…æœ‰æ•ˆ
- ä¸åŒäº§å“çš„æ£€æµ‹æµç¨‹ä½¿ç”¨**ä¸åŒçš„Session**å®ä¾‹
- ç®—æ³•é‡å¯åSessionæ•°æ®**ä¸ä¼šä¿ç•™**
- Sessionä¼šè‡ªåŠ¨æ¸…ç†**è¿‡æœŸçš„TTLæ•°æ®**
- Sessionæ•°æ®å­˜å‚¨åœ¨**å†…å­˜**ä¸­ï¼Œä¸è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼ˆå»ºè®®<100KBï¼‰
```

---

## ğŸ“‹ å†³ç­–åº”ç”¨çŠ¶æ€æ±‡æ€»

### é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆv0.2.1 å¿…é¡»ä¿®å¤ï¼‰âœ…

| åºå· | é—®é¢˜ | å†³ç­– | çŠ¶æ€ |
|------|------|------|------|
| 1 | overlayå­—æ®µçŸ›ç›¾ | ç»Ÿä¸€ä¸æ”¯æŒ | âœ… å·²åº”ç”¨ |
| 2 | required_assetsæ ‡è®°å†²çª | ä¿ç•™å¹¶å®Œå–„ | âœ… å·²åº”ç”¨ |
| 3 | executeè¿”å›ERRORæ ¼å¼ | å®šä¹‰æ ‡å‡†æ ¼å¼ | âœ… å·²åº”ç”¨ |
| 4 | è¾¹ç•Œåœºæ™¯ç¼ºå¤± | è¡¥å……15ä¸ªåœºæ™¯ | âœ… å·²åº”ç”¨ |
| 5 | Session APIæœªå®šä¹‰ | å®šä¹‰å®Œæ•´API | âœ… å·²åº”ç”¨ |

### ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆv0.2.5 è®¡åˆ’ä¿®å¤ï¼‰â³

| åºå· | é—®é¢˜ | å†³ç­– | çŠ¶æ€ |
|------|------|------|------|
| 6 | ç¼ºå°‘å®Œæ•´ç®—æ³•ç¤ºä¾‹é¡¹ç›® | æš‚ç¼“ï¼Œåç»­å¤„ç† | â¸ï¸ å·²åˆ—å…¥v0.2.5 |
| 7 | æœ¯è¯­ä½¿ç”¨ä¸ä¸€è‡´ | è®¡åˆ’ç»Ÿä¸€ | â¸ï¸ å·²åˆ—å…¥v0.2.5 |
| 8 | ç¼ºå°‘æ€§èƒ½çº¦æŸè¯´æ˜ | è®¡åˆ’è¡¥å…… | â¸ï¸ å·²åˆ—å…¥v0.2.5 |
| 9 | å‚æ•°ç±»å‹ç³»ç»Ÿä¸å®Œæ•´ | å·²è¡¥å…… | âœ… å·²åº”ç”¨ |
| 10 | ç¼ºå°‘æ¶æ„å›¾ | æš‚ç¼“ï¼Œåç»­å¤„ç† | â¸ï¸ å·²åˆ—å…¥v0.3.0 |

### å·²æ¥å—é£é™©çš„é—®é¢˜ âœ…

| åºå· | é—®é¢˜ | å†³ç­– | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|------|----------|----------|
| 1 | èµ„æºç®¡ç†ç¼ºä¹çº¦æŸ | æ¥å—é£é™© | ä¸­ | v0.3.0å¢åŠ ç›‘æ§æ¥å£ |
| 2 | åè®®æ•°æ®åŒ…å¤§å°æ— é™åˆ¶ | æ¥å—é£é™© | ä¸­ | å¢åŠ é…ç½®è¯´æ˜ |

---

## ğŸš€ ç‰ˆæœ¬æ¼”è¿›è·¯çº¿

### v0.2.1 (å½“å‰ç‰ˆæœ¬ - å·²åº”ç”¨ä¿®æ”¹)

**ä¸»è¦å˜æ›´**:
- âœ… ä¿®å¤ overlay å­—æ®µçŸ›ç›¾
- âœ… ä¿®å¤ required_assets æ ‡è®°å†²çª
- âœ… ç»Ÿä¸€æ—¶é—´æˆ³æ ¼å¼ä¸º timestamp_ms
- âœ… ä¼˜åŒ–æ¥å£å‚æ•°é¡ºåº
- âœ… æå– BaseResponse ç»Ÿä¸€ schema
- âœ… æ˜ç¡®å­—æ®µçº¦æŸï¼ˆdefect_rects â‰¤ 20ï¼‰
- âœ… è¡¥å……å‚æ•°ç±»å‹ç³»ç»Ÿï¼ˆstring/array/jsonï¼‰
- âœ… å®Œå–„ä»£ç ç¤ºä¾‹ï¼ˆç±»å‹æ³¨è§£ã€superè°ƒç”¨ï¼‰
- âœ… å¢åŠ é˜²å¾¡å¼ç¼–ç¨‹ç¤ºä¾‹
- âœ… è¡¥å……è¾¹ç•Œåœºæ™¯å¤„ç†æŒ‡å—ï¼ˆ15ä¸ªåœºæ™¯ï¼‰
- âœ… å®šä¹‰æ ‡å‡†é”™è¯¯ç è¡¨ï¼ˆ7ä¸ªé”™è¯¯ç ï¼‰
- âœ… å®šä¹‰å®Œæ•´ Session API

**æ–‡æ¡£è´¨é‡**: B+ â†’ **A-**

### v0.2.5 (è®¡åˆ’ä¸­)

**è®¡åˆ’å˜æ›´**:
- åˆ›å»º `algorithm_sample/` å®Œæ•´ç¤ºä¾‹é¡¹ç›®
- ç»Ÿä¸€æœ¯è¯­ä½¿ç”¨ï¼ˆåˆ›å»ºæœ¯è¯­è¡¨ï¼‰
- è¡¥å……æ€§èƒ½çº¦æŸè¯´æ˜ï¼ˆæœ€å¤§å»¶è¿Ÿã€ååé‡ï¼‰
- å¢åŠ æ›´å¤šè¾¹ç•Œåœºæ™¯å¤„ç†ç¤ºä¾‹
- åˆ›å»º Dev Runner ä½¿ç”¨æŒ‡å—

### v0.3.0 (æœªæ¥ç‰ˆæœ¬)

**è®¡åˆ’å˜æ›´**:
- æ·»åŠ ç³»ç»Ÿæ¶æ„å›¾ï¼ˆMermaid/PlantUMLï¼‰
- æ·»åŠ  Session ç”Ÿå‘½å‘¨æœŸæ—¶åºå›¾
- æ·»åŠ è°ƒç”¨æµç¨‹å›¾
- å¢åŠ èµ„æºç›‘æ§æ¥å£ï¼ˆget_resource_usageï¼‰
- å®Œå–„å¯è§‚æµ‹æ€§ï¼ˆget_metricsï¼‰

---

## ğŸ“Š å®¡æŸ¥è¯„åˆ†æ›´æ–°

### ä¿®æ”¹å‰è¯„åˆ† (v0.2.0)

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | é—®é¢˜æ•° |
|----------|------|--------|
| æ¶æ„è®¾è®¡ | â˜…â˜…â˜…â˜…â˜† | 3 |
| æ¥å£è§„èŒƒ | â˜…â˜…â˜…â˜…â˜† | 2 |
| æ–‡æ¡£è´¨é‡ | â˜…â˜…â˜…â˜†â˜† | 8 |
| é”™è¯¯å¤„ç† | â˜…â˜…â˜…â˜†â˜† | 6 |
| å¯æ‰©å±•æ€§ | â˜…â˜…â˜…â˜…â˜… | 0 |
| **ä¸€è‡´æ€§** | â˜…â˜…â˜…â˜†â˜† | **5** |

**ç»¼åˆè¯„åˆ†**: B+ (è‰¯å¥½ - æœ‰æ¡ä»¶é€šè¿‡)

### ä¿®æ”¹åè¯„åˆ† (v0.2.1)

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | æ”¹è¿› |
|----------|------|------|
| æ¶æ„è®¾è®¡ | â˜…â˜…â˜…â˜…â˜† | ä¿æŒ |
| æ¥å£è§„èŒƒ | â˜…â˜…â˜…â˜…â˜… | â¬†ï¸ +1 |
| æ–‡æ¡£è´¨é‡ | â˜…â˜…â˜…â˜…â˜† | â¬†ï¸ +1 |
| é”™è¯¯å¤„ç† | â˜…â˜…â˜…â˜…â˜† | â¬†ï¸ +1 |
| å¯æ‰©å±•æ€§ | â˜…â˜…â˜…â˜…â˜… | ä¿æŒ |
| **ä¸€è‡´æ€§** | â˜…â˜…â˜…â˜…â˜… | â¬†ï¸ +2 |

**ç»¼åˆè¯„åˆ†**: **A- (ä¼˜ç§€ - é€šè¿‡)**

---

## âœ… å®¡æŸ¥ç»“è®º

### æœ€ç»ˆå®¡æŸ¥çŠ¶æ€: âœ… **å·²é€šè¿‡**

**ProcVisionç®—æ³•SDKè§„èŒƒæ–‡æ¡£(v0.2.1)** å·²é€šè¿‡æ¶æ„å®¡æŸ¥ï¼Œ**è¯„å®šç­‰çº§: A- (ä¼˜ç§€)**

**å®¡æŸ¥æ€»ç»“**:
- âœ… æ‰€æœ‰é«˜ä¼˜å…ˆçº§é—®é¢˜å·²è§£å†³ï¼ˆ5/5ï¼‰
- âœ… æ–‡æ¡£ä¸€è‡´æ€§æ˜¾è‘—æå‡ï¼ˆâ˜…â˜…â˜…â˜…â˜…ï¼‰
- âœ… é”™è¯¯å¤„ç†è¦†ç›–å®Œæ•´ï¼ˆâ˜…â˜…â˜…â˜…â˜†ï¼‰
- âœ… æ¥å£è§„èŒƒæ¸…æ™°å®Œæ•´ï¼ˆâ˜…â˜…â˜…â˜…â˜…ï¼‰
- âœ… ä»£ç ç¤ºä¾‹è´¨é‡æ”¹å–„ï¼ˆæ–°å¢ç±»å‹æ³¨è§£å’Œæ³¨é‡Šï¼‰

**å‰©ä½™å·¥ä½œ**:
- â¸ï¸ v0.2.5: åˆ›å»ºå®Œæ•´ç¤ºä¾‹é¡¹ç›®ï¼ˆè®¡åˆ’ä¸­ï¼‰
- â¸ï¸ v0.3.0: æ·»åŠ å¯è§†åŒ–å›¾è¡¨ï¼ˆè®¡åˆ’ä¸­ï¼‰
- âš ï¸ ç›‘æ§èµ„æºä½¿ç”¨ï¼ˆé£é™©æ¥å—ï¼‰

**æ¨è**: **âœ… æ‰¹å‡†è¿›å…¥ä¸‹ä¸€é˜¶æ®µå¼€å‘**

---

## ğŸ¯ å…³é”®æˆæœ

### æ–‡æ¡£æ”¹è¿›ç»Ÿè®¡

```
åŸå§‹æ–‡æ¡£ (v0.2.0):
- æ€»è¡Œæ•°: 1421è¡Œ
- ä»£ç ç¤ºä¾‹: 12ä¸ªï¼ˆä¸å®Œæ•´ï¼‰
- å›¾è¡¨æ•°é‡: 0
- é”™è¯¯ç : 0
- è¾¹ç•Œåœºæ™¯: 0

ä¿®æ”¹åæ–‡æ¡£ (v0.2.1):
- æ€»è¡Œæ•°: ~1800è¡Œ (+379è¡Œ)
- ä»£ç ç¤ºä¾‹: 18ä¸ªï¼ˆå®Œæ•´ç±»å‹æ³¨è§£ï¼‰
- å›¾è¡¨æ•°é‡: 0ï¼ˆv0.3.0æ·»åŠ ï¼‰
- é”™è¯¯ç : 7ä¸ªï¼ˆæ ‡å‡†å®šä¹‰ï¼‰
- è¾¹ç•Œåœºæ™¯: 26ä¸ªï¼ˆå®Œæ•´è¦†ç›–ï¼‰
```

### å·²éªŒè¯çš„å…³é”®æ”¹è¿›

1. âœ… **ä¸€è‡´æ€§**: æ¶ˆé™¤æ‰€æœ‰æœ¯è¯­çŸ›ç›¾ï¼ˆoverlayã€required_assetsï¼‰
2. âœ… **å®Œæ•´æ€§**: è¡¥å……å…³é”®åœºæ™¯ï¼ˆè¾¹ç•Œå¤„ç†ã€é”™è¯¯ç ã€Session APIï¼‰
3. âœ… **å¯ç”¨æ€§**: ä»£ç ç¤ºä¾‹æ ‡å‡†åŒ–ï¼ˆç±»å‹æ³¨è§£ã€æ–‡æ¡£æ³¨é‡Šï¼‰
4. âœ… **å¯ç»´æŠ¤æ€§**: DRYåŸåˆ™åº”ç”¨ï¼ˆBaseResponseç»Ÿä¸€ schemaï¼‰
5. âœ… **å¯æ‰©å±•æ€§**: å‚æ•°ç±»å‹ç³»ç»Ÿå®Œæ•´ï¼ˆ8ç§åŸºç¡€ç±»å‹ï¼‰

---

## ğŸ“Œ ç­¾å

**å®¡æŸ¥æ—¥æœŸ**: 2025-11-20
**å®¡æŸ¥çŠ¶æ€**: âœ… **å·²é€šè¿‡**
**ä¸‹æ¬¡å®¡æŸ¥**: v0.2.5 ç‰ˆæœ¬å‘å¸ƒå

---

**æœ¬å®¡æŸ¥æŠ¥å‘Šå·²æ ¹æ®ç”¨æˆ·å†³ç­–å®Œæˆä¿®æ”¹ï¼Œæ‰€æœ‰é«˜ä¼˜å…ˆçº§é—®é¢˜å·²è§£å†³ï¼Œæ–‡æ¡£å·²å‡çº§è‡³ v0.2.1ã€‚**

**æ¶æ„å¸ˆç­¾å**: ___________________

**ç”¨æˆ·ç¡®è®¤**: ___________________

**æ–‡æ¡£ç‰ˆæœ¬**: v0.2.1 (å¾…å‘å¸ƒ)

---

*æœ¬æŠ¥å‘ŠåŸºäº ARCHITECTURE_REVIEW_v0.2.0.md ä¸­çš„å†³ç­–æªæ–½ç”Ÿæˆï¼Œæ‰€æœ‰æ¨èä¿®æ”¹å·²åº”ç”¨æˆ–åˆ—å…¥è·¯çº¿å›¾ã€‚*
